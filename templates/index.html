<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nginx Dashboard</title>
<style>
    body {
        font-family: monospace;
        padding: 20px;
        background: #111;
        color: #ddd;
    }
    h2 { margin-top: 25px; }
    .active { color: #7CFC00; }
    .inactive { color: #ff5050; }
    table { border-collapse: collapse; width: 80%; }
    td, th { border: 1px solid #444; padding: 8px; text-align: left; }
    pre {
        background: #000;
        border: 1px solid #333;
        padding: 10px;
        height: 400px;
        overflow-y: scroll;
    }
    button { margin: 4px; padding: 6px 12px; cursor: pointer; }
    tr.good { background: #063; color: #9f9; }
    tr.bad { background: #400; color: #faa; }
</style>
</head>
<body>

<h1>Nginx Dashboard</h1>

<h2>Sites (auto-pinging...)</h2>
<table id="site-table">
    <tr>
        <th>Site</th>
        <th>Status</th>
        <th>Ports</th>
        <th>HTTP Code</th>
    </tr>
</table>

<h2>Logs</h2>
<div id="log-list"></div>

<h2>Log Output</h2>
<pre id="log-output">Select a log file...</pre>

<script>
async function loadSites() {
    const res = await fetch("/api/sites");
    const data = await res.json();
    const table = document.getElementById("site-table");
    table.innerHTML = `
        <tr>
            <th>Site</th>
            <th>Status</th>
            <th>Ports</th>
            <th>HTTP Code</th>
        </tr>`;

    for (const s of data.sites) {
        const status = s.active ? "active" : "inactive";
        const ports = s.ports.length ? s.ports.join(", ") : "-";

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${s.name}</td>
            <td class="${status}">${status}</td>
            <td>${ports}</td>
            <td id="code-${s.name}">...</td>
        `;
        table.appendChild(row);

        // Try pinging the site (localhost + first port)
        if (s.ports.length > 0) {
            const port = s.ports[0];
            pingSite(s.name, port, row);
        } else {
            row.classList.add("bad");
            document.getElementById(`code-${s.name}`).textContent = "N/A";
        }
    }
}

async function pingSite(siteName, port, row) {
    const codeCell = document.getElementById(`code-${siteName}`);
    try {
        const resp = await fetch(`http://localhost:${port}`, { method: "GET" });
        codeCell.textContent = resp.status;
        if (resp.status === 200) {
            row.classList.add("good");
        } else {
            row.classList.add("bad");
        }
    } catch (e) {
        codeCell.textContent = "ERR";
        row.classList.add("bad");
    }
}

async function loadLogs() {
    const res = await fetch("/api/logs");
    const data = await res.json();
    const div = document.getElementById("log-list");
    div.innerHTML = "";

    data.logs.forEach(log => {
        div.innerHTML += `<button onclick="viewLog('${log}')">${log}</button>`;
    });
}

async function viewLog(name) {
    const res = await fetch(`/api/logs/${name}?lines=300`);
    const text = await res.text();
    document.getElementById("log-output").textContent = text;
}

// Load sites and logs
loadSites();
loadLogs();

// Optional: auto-refresh logs every few seconds in the future
</script>

</body>
</html>
