<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nginx Dashboard</title>
<style>
    body { font-family: monospace; padding: 20px; background: #111; color: #ddd; }
    h2 { margin-top: 25px; }
    table { border-collapse: collapse; width: 90%; }
    td, th { border: 1px solid #444; padding: 8px; text-align: left; }
    pre { background: #000; border: 1px solid #333; padding: 10px; height: 400px; overflow-y: scroll; }
    button { margin: 4px; padding: 6px 12px; cursor: pointer; }
    tr.good { background: #063; color: #9f9; }
    tr.bad { background: #400; color: #faa; }
    .active { font-weight: bold; }
    .inactive { opacity: 0.6; }
</style>
</head>
<body>

<h1>Nginx Dashboard</h1>

<h2>Sites (auto-pinging...)</h2>
<table id="site-table">
    <tr>
        <th>Site</th>
        <th>Status</th>
        <th>Internal Port</th>
        <th>HTTP Code</th>
    </tr>
</table>

<h2>Logs</h2>
<div id="log-list"></div>

<h2>Log Output</h2>
<pre id="log-output">Select a log file...</pre>

<script>
async function loadSites() {
    const res = await fetch("/api/sites");
    const data = await res.json();
    const table = document.getElementById("site-table");
    table.innerHTML = `
        <tr>
            <th>Site</th>
            <th>Status</th>
            <th>Internal Port</th>
            <th>HTTP Code</th>
        </tr>`;

    for (const s of data.sites) {
        const statusClass = s.active ? "active" : "inactive";

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${s.site}</td>
            <td class="${statusClass}">${s.active ? "active" : "inactive"}</td>
            <td>${s.internal_port}</td>
            <td id="code-${s.site}">...</td>
        `;
        table.appendChild(row);

        pingSite(s.site, row);
    }
}

async function pingSite(site, row) {
    const codeCell = document.getElementById(`code-${site}`);
    try {
        const res = await fetch(`/api/ping?url=${encodeURIComponent(site)}`);
        const data = await res.json();
        if (data.status_code) {
            codeCell.textContent = data.status_code;
            row.classList.add(data.status_code === 200 ? "good" : "bad");
        } else {
            codeCell.textContent = "ERR";
            row.classList.add("bad");
        }
    } catch (e) {
        codeCell.textContent = "ERR";
        row.classList.add("bad");
    }
}

async function loadLogs() {
    const res = await fetch("/api/logs");
    const data = await res.json();
    const div = document.getElementById("log-list");
    div.innerHTML = "";

    data.logs.forEach(log => {
        div.innerHTML += `<button onclick="viewLog('${log}')">${log}</button>`;
    });
}

async function viewLog(name) {
    const res = await fetch(`/api/logs/${name}?lines=300`);
    const text = await res.text();
    document.getElementById("log-output").textContent = text;
}

loadSites();
loadLogs();
</script>

</body>
</html>
